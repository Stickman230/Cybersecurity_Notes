#eJPT #INE #Windows #PrivEsc


| COMMAND                              | FUNCTION                                     |
| ------------------------------------ | -------------------------------------------- |
| *getpriv*                            | (METASPLOIT) Show priviledge of current user |
| *getuid*                             | (METASPLOIT) Show username                   |
| *net users*                          | show user accounts                           |
| *net localgroup administrators*      | show users in admin group                    |
| *certutils -urlcache -f  http://*ULR | download file from http server windows       |
| *powershell -ep bypass*<br>          | bypass execution policy for scripts          |
|                                      |                                              |

# Windows Kernel

*A Kernel is a computer program that is the core of an operating system and has complete control over every resource and hardware on a system. It acts as a translation layer between hardware and software and facilitates the communication between these two layers.*

**Windows NT is the kernel** that comes pre-packaged with all versions of Microsoft Windows

Two main modes of operation that determine access to system resources and hardware:
- **User Mode** – Programs and services running in user mode have limited access to system resources and functionality.
- **Kernel Mode** – Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory.

#### (TOOL) Windows-Exploit-Suggester 
- This tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.
+ GitHub: https://github.com/AonCyberLabs/Windows-Exploit-Suggester

#### Finding correct exploits with metasploit
1. Get a meterpreter session on target 
2. run `post/muti/recon/local_exploit_suggester`

---
# User Account Control (UAC)

*User Account Control (UAC) is a Windows security feature introduced in Windows Vista that is used to prevent unauthorized changes from being made to the operating system.*

A **non-privileged user attempting to execute a program with elevated privileges will be prompted with the UAC credential prompt**, whereas a **privileged user will be prompted with a consent prompt**
## Bypassing UAC

*In order to successfully bypass UAC, we will need to have access to a user account that is a part of the local administrators group on the Windows target system.*
#### (TOOL) UACMe 
- It is an open source, robust privilege escalation tool developed by @hfire0x. It can be used to bypass Windows UAC by leveraging various techniques.
- GitHub: https://github.com/hfiref0x/UACME

#### Using UACMe

1. Get a meterpreter session.
2. Upload reverse shell payload and Akagi32.exe
3. Call back to you using Metasploit multi/handler listener and executing akagi32.exe
4. Migrate to NT/authority system process

---
# Windows Access Token 

*Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).*

**Access tokens are generated by the winlogon.exe process** every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process

This token is **then attached to the userinit.exe process**, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

## Types of tokens

An access token will typically be assigned one of the following security levels: 
- **Impersonate-level tokens** are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons.
- **Delegate-level tokens** are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP.
*Delegate-level tokens pose the largest threat*

The following are the privileges that are required for a successful impersonation attack:
- **SeAssignPrimaryToken**: This allows a user to impersonate tokens.
- **SeCreateToken**: This allows a user to create an arbitrary token with administrative privileges.
- **SeImpersonatePrivilege**: This allows a user to create a process under the security context of another user typically with administrative privileges.

#### Access Token Impersonation

1. Get a meterpreter session exploiting vulnerable service ( `use exploit/windows/http/rejetto_hfs_exec`)
2. `load incognito`
3. `list_tokens -u`
4. `impersonate_token "TOKEN_NAME"`

---

# Alternate Data Streams (ADS)

*ADS is an NTFS (New Technology File System) file attribute and was designed to provide compatibility with the MacOS HFS (Hierarchical File System).*

● **Any file created on an NTFS formatted drive** will have two different forks/streams:
- ***Data stream*** - Default stream that contains the data of the file.
- ***Resource stream*** - Typically contains the metadata of the file.

● Attackers can *use ADS to hide malicious code or executables* in legitimate files in order to evade detection.
● This can be done by **storing the malicious code or executables in the file attribute resource stream (metadata)** of a legitimate file.
● This technique is **usually used to evade basic signature based AVs and static scanning tools.**

#### Using ADS

```bash
notepad text.txt:secret.txt
type exploit.exe > textfile.txt:hidden_exploit.exe (make a symbolic link to the hidden executable)
```

---
# Windows Hashes

*The Windows OS stores hashed user account passwords locally in the SAM (Security Accounts Manager) database*

Authentication and verification of user credentials is facilitated by the **Local Security Authority** (LSA).

- Windows versions up to Windows Server 2003 utilize two different types of hashes:
	+ LM
	+ NTLM

*Windows disables LM hashing and utilizes NTLM hashing from Windows Vista onwards.*

## SAM

SAM (Security Account Manager) is a database file that is responsible for managing user accounts and passwords on Windows. All user account passwords stored in the SAM database are hashed.

● The **SAM database file cannot be copied while the operating system is running.**
● The Windows NT kernel keeps the SAM database file locked and as a result, attackers typically **utilize in-memory techniques and tools to dump SAM hashes from the LSASS process**.
● *In modern versions of Windows, the SAM database is encrypted with a syskey.*

**Elevated/Administrative privileges are required in order to access and interact with the LSASS process.**

## NTLM hashing

*NTLM is a collection of authentication protocols that are utilized in Windows to facilitate authentication between computers. The authentication process involves using a valid username and password to authenticate successfully.*

● When a user account is created, it is encrypted using the MD4 hashing algorithm, while the original password is disposed of.
● NTLM improves upon LM in the following ways:
+ **Does not split the hash in to two chunks.**
+ **Case sensitive.**
+ **Allows the use of symbols and unicode characters.**

![[NTLM_HASH.png]]

## Dumping Hashes with Mimikatz
---
# Windows configuration files

*Windows can automate a variety of repetitive tasks, such as the mass rollout or installation of Windows on many systems.*

This is typically done through the use of the **Unattended Windows Setup utility**

The Unattended Windows Setup utility will typically utilize one of the following configuration files that contain user account and system configuration information:
- C:\Windows\Panther\Unattend.xml
- C:\Windows\Panther\Autounattend.xml

● As a security precaution, *the passwords stored in the Unattended Windows Setup configuration file may be encoded in base64*.

#### (TOOL) PowerUp powershell

*PowerUp aims to be a clearinghouse of common Windows privilege escalation vectors that rely on misconfigurations.*

https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1